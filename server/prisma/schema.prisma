generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum KitchenType {
  KING
  BRANCH
}

enum UserRole {
  OWNER
  ADMIN
  MANAGER
  STOREKEEPER
  HR
  EMPLOYEE
}

enum StockLedgerType {
  PURCHASE
  TRANSFER_OUT
  TRANSFER_IN
  ADJUSTMENT
  WASTAGE
  CONSUMPTION
}

enum TransferStatus {
  REQUESTED
  APPROVED
  DISPATCHED
  RECEIVED
  CANCELLED
}

enum AttendanceType {
  IN
  OUT
}

enum AttendanceMethod {
  GEO
  MANUAL
}

enum PayrollPeriodStatus {
  DRAFT
  FINAL
}

enum ReminderType {
  PAYROLL_DUE
  LOW_STOCK
}

enum ReminderStatus {
  OPEN
  DONE
}

model Kitchen {
  id                   String   @id @default(cuid())
  name                 String
  type                 KitchenType
  address              String?
  lat                  Float?
  lng                  Float?
  geofenceRadiusMeters Int      @default(150)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  users      User[]
  stocks     KitchenStock[]
  ledger     StockLedger[]
  purchases  PurchaseOrder[]
  transfersFrom Transfer[] @relation("TransferFromKitchen")
  transfersTo   Transfer[] @relation("TransferToKitchen")
  attendanceEvents AttendanceEvent[]
  shiftSummaries   ShiftDaySummary[]

  @@index([type])
}

model User {
  id           String   @id @default(cuid())
  email        String?  @unique
  phone        String?  @unique
  passwordHash String
  role         UserRole @default(EMPLOYEE)
  isActive     Boolean  @default(true)
  kitchenId    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  kitchen Kitchen? @relation(fields: [kitchenId], references: [id])
  employeeProfile EmployeeProfile?

  createdLedgerEntries StockLedger[] @relation("LedgerCreatedBy")
  requestedTransfers   Transfer[]    @relation("TransferRequestedBy")
  approvedTransfers    Transfer[]    @relation("TransferApprovedBy")
  dispatchedTransfers  Transfer[]    @relation("TransferDispatchedBy")
  receivedTransfers    Transfer[]    @relation("TransferReceivedBy")
  attendanceEvents     AttendanceEvent[]
  shiftSummaries       ShiftDaySummary[]
  payrollEntries       PayrollEntry[]
  remindersCreated     Reminder[] @relation("ReminderCreatedBy")
  auditLogs            AuditLog[]
}

model EmployeeProfile {
  userId              String  @id
  fullName            String
  baseSalaryMonthly   Int
  overtimeRatePerHour Int     @default(0)
  latePenaltyPerMinute Int    @default(0)
  joinDate            DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Supplier {
  id        String   @id @default(cuid())
  name      String
  contact   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchaseOrders PurchaseOrder[]
}

model Item {
  id           String   @id @default(cuid())
  name         String
  category     String?
  uom          String
  reorderPoint Float    @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  stocks KitchenStock[]
  ledger StockLedger[]
  purchaseLines PurchaseLine[]
  transferLines TransferLine[]

  @@unique([name, uom])
  @@index([category])
  @@index([name])
}

model KitchenStock {
  kitchenId String
  itemId    String
  onHandQty Float   @default(0)
  avgCost   Float   @default(0)
  updatedAt DateTime @updatedAt

  kitchen Kitchen @relation(fields: [kitchenId], references: [id], onDelete: Cascade)
  item    Item    @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@id([kitchenId, itemId])
}

model StockLedger {
  id        String         @id @default(cuid())
  kitchenId String
  itemId    String
  type      StockLedgerType
  qtyDelta  Float
  unitCost  Float?
  refType   String?
  refId     String?
  createdByUserId String?
  createdAt DateTime       @default(now())

  kitchen Kitchen @relation(fields: [kitchenId], references: [id], onDelete: Cascade)
  item    Item    @relation(fields: [itemId], references: [id], onDelete: Cascade)
  createdBy User? @relation("LedgerCreatedBy", fields: [createdByUserId], references: [id])

  @@index([kitchenId, itemId, createdAt])
  @@index([refType, refId])
}

model PurchaseOrder {
  id         String   @id @default(cuid())
  kitchenId  String
  supplierId String?
  status     String   @default("DRAFT")
  createdByUserId String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  kitchen  Kitchen  @relation(fields: [kitchenId], references: [id], onDelete: Cascade)
  supplier Supplier? @relation(fields: [supplierId], references: [id])
  lines    PurchaseLine[]
}

model PurchaseLine {
  id        String @id @default(cuid())
  purchaseOrderId String
  itemId    String
  qty       Float
  unitCost  Float

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  item          Item          @relation(fields: [itemId], references: [id], onDelete: Restrict)

  @@index([purchaseOrderId])
}

model Transfer {
  id            String         @id @default(cuid())
  fromKitchenId String
  toKitchenId   String
  status        TransferStatus @default(REQUESTED)

  requestedByUserId String?
  approvedByUserId  String?
  dispatchedByUserId String?
  receivedByUserId  String?

  requestedAt  DateTime @default(now())
  approvedAt   DateTime?
  dispatchedAt DateTime?
  receivedAt   DateTime?
  cancelledAt  DateTime?

  fromKitchen Kitchen @relation("TransferFromKitchen", fields: [fromKitchenId], references: [id], onDelete: Cascade)
  toKitchen   Kitchen @relation("TransferToKitchen", fields: [toKitchenId], references: [id], onDelete: Cascade)
  lines       TransferLine[]

  requestedBy  User? @relation("TransferRequestedBy", fields: [requestedByUserId], references: [id])
  approvedBy   User? @relation("TransferApprovedBy", fields: [approvedByUserId], references: [id])
  dispatchedBy User? @relation("TransferDispatchedBy", fields: [dispatchedByUserId], references: [id])
  receivedBy   User? @relation("TransferReceivedBy", fields: [receivedByUserId], references: [id])

  @@index([fromKitchenId, status])
  @@index([toKitchenId, status])
}

model TransferLine {
  id         String @id @default(cuid())
  transferId String
  itemId     String
  qty        Float

  transfer Transfer @relation(fields: [transferId], references: [id], onDelete: Cascade)
  item     Item     @relation(fields: [itemId], references: [id], onDelete: Restrict)

  @@index([transferId])
}

model AttendanceEvent {
  id            String           @id @default(cuid())
  employeeUserId String
  kitchenId      String
  type          AttendanceType
  method        AttendanceMethod @default(GEO)
  lat           Float?
  lng           Float?
  distanceMeters Float?
  createdAt     DateTime @default(now())

  employee User    @relation(fields: [employeeUserId], references: [id], onDelete: Cascade)
  kitchen  Kitchen @relation(fields: [kitchenId], references: [id], onDelete: Cascade)

  @@index([employeeUserId, createdAt])
  @@index([kitchenId, createdAt])
}

model ShiftDaySummary {
  id             String   @id @default(cuid())
  employeeUserId String
  kitchenId      String
  date           DateTime
  minutesWorked  Int      @default(0)
  minutesLate    Int      @default(0)
  overtimeMinutes Int     @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  employee User    @relation(fields: [employeeUserId], references: [id], onDelete: Cascade)
  kitchen  Kitchen @relation(fields: [kitchenId], references: [id], onDelete: Cascade)

  @@unique([employeeUserId, kitchenId, date])
}

model PayrollPeriod {
  id        String             @id @default(cuid())
  month     String             @unique
  status    PayrollPeriodStatus @default(DRAFT)
  generatedAt DateTime         @default(now())

  entries PayrollEntry[]
}

model PayrollEntry {
  id            String   @id @default(cuid())
  periodId      String
  employeeUserId String
  computedSalary Int
  overtimePay    Int @default(0)
  deductions     Int @default(0)
  netPay         Int
  paidAt         DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  period   PayrollPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)
  employee User         @relation(fields: [employeeUserId], references: [id], onDelete: Cascade)

  @@unique([periodId, employeeUserId])
}

model Reminder {
  id        String        @id @default(cuid())
  type      ReminderType
  dueAt     DateTime
  status    ReminderStatus @default(OPEN)
  payload   Json
  createdByUserId String?
  createdAt DateTime @default(now())
  doneAt    DateTime?

  createdBy User? @relation("ReminderCreatedBy", fields: [createdByUserId], references: [id])

  @@index([status, dueAt])
}

model AuditLog {
  id         String   @id @default(cuid())
  actorUserId String?
  action     String
  entityType String
  entityId   String?
  meta       Json
  createdAt  DateTime @default(now())

  actor User? @relation(fields: [actorUserId], references: [id])

  @@index([entityType, entityId])
  @@index([createdAt])
}

